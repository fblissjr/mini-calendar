<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Template</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            overscroll-behavior-y: contain; 
        }
        .calendar-app-container {
            max-width: 1200px;
            margin: 0 auto; 
            padding: 0.5rem; 
            display: flex;
            flex-direction: column;
            min-height: 100vh; 
        }
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            gap: 0.5rem; 
            margin-bottom: 1rem; 
            padding: 0.75rem; 
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-button, .action-button-style, .export-csv-button, .print-button, .view-toggle-button { 
            background-color: #6366f1; /* Lighter base color */
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0; 
        }
        .nav-button:hover, .action-button-style:hover, .export-csv-button:hover, .print-button:hover, .view-toggle-button:hover {
            background-color: #4f46e5; /* Darker on hover */
        }
        .view-toggle-button.active {
             background-color: #4f46e5;
             box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .navigation-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .view-toggle-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background-color: #e0e7ff;
            padding: 0.25rem;
            border-radius: 0.5rem;
        }

        .current-month-display {
            font-size: 1.25rem; 
            font-weight: 700;
            color: #4f46e5;
            text-align: center;
            flex-grow: 1; 
            margin: 0 0.5rem; 
        }
         .export-csv-button { background-color: #10b981; }
        .export-csv-button:hover { background-color: #059669; }
        .print-button { background-color: #64748b; }
        .print-button:hover { background-color: #475569; }

        /* Calendar Views */
        #calendar-grid-container, #week-view-container {
            flex-grow: 1; 
        }
        
        /* --- Month View --- */
        .month {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border-top: 1px solid #e5e7eb;
        }
        .day-label, .day-cell {
            padding: 0.25rem; 
            text-align: center;
            font-size: 0.75rem; 
        }
        .day-label { background-color: #f9fafb; font-weight: 600; }
        .day-cell {
            background-color: white;
            min-height: 70px; 
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 0.25rem;
            cursor: pointer; 
            transition: background-color 0.2s ease-in-out;
        }
        .day-cell:hover:not(.other-month) { background-color: #eef2ff; }
        .day-number { font-weight: 600; margin-bottom: 0.1rem; font-size: 0.8rem; }
        .other-month { color: #9ca3af; background-color: #f9fafb; cursor: default; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; margin: 1px auto; }
        .event { 
            font-size: 0.7rem; padding: 0.1rem 0.3rem; border-radius: 0.25rem; margin-top: 0.1rem; 
            width: 95%; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* --- Week View --- */
        #week-view-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .week-day-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 0.75rem;
        }
        .week-day-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .week-day-name { font-weight: 600; font-size: 1rem; }
        .week-day-date { font-size: 0.8rem; color: #6b7280; }
        .week-day-events .event {
            width: 100%; margin-top: 0.25rem; padding: 0.5rem; 
            font-size: 0.875rem; white-space: normal;
        }
        .week-day-events .event:hover {
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
             transform: translateY(-1px);
        }

        .today .day-number {
            background-color: #4f46e5;
            color: white;
            border-radius: 50%;
            width: 1.5em; 
            height: 1.5em;
            line-height: 1.5em;
            display: inline-block;
            font-weight: bold;
        }
        .week-day-card.today {
            border: 2px solid #4f46e5;
            background-color: #eef2ff;
        }

        /* Action Drawer, Collapsible Sections, Search, etc. */
        .action-drawer-fab { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999; }
        .fab-main-button { background-color: #4f46e5; color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s ease-in-out, background-color 0.2s; }
        .fab-main-button:hover { background-color: #4338ca; transform: scale(1.05); }
        .fab-main-button i { font-size: 1.5rem; }
        .fab-actions { position: absolute; bottom: 70px; right: 0; display: flex; flex-direction: column; gap: 0.75rem; align-items: flex-end; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateY(10px); pointer-events: none; }
        .fab-actions.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-action-item { background-color: #6366f1; color: white; padding: 0.6rem 1rem; border-radius: 0.375rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; white-space: nowrap; }
        .fab-action-item:hover { background-color: #4f46e5; }
        .fab-action-item i { margin-right: 0.5rem; }
        .search-bar-container { display: none; padding: 0.5rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        .search-bar-container input { width: calc(100% - 70px); padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.375rem 0 0 0.375rem; font-size: 0.875rem; }
        .search-bar-container button { padding: 0.6rem 1rem; border-radius: 0 0.375rem 0.375rem 0; background-color: #6b7280; }
        .search-bar-container button:hover { background-color: #4b5563; }
        .collapsible-section { display: none; position: fixed; bottom: 0; left: 0; right: 0; max-height: 80vh; background-color: white; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); padding: 1rem; overflow-y: auto; z-index: 990; border-top-left-radius: 1rem; border-top-right-radius: 1rem; transition: transform 0.3s ease-out; transform: translateY(100%); }
        .collapsible-section.active { display: block; transform: translateY(0); }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .collapsible-header h3 { margin: 0; font-size: 1.25rem; color: #4f46e5; }
        .close-collapsible-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
        #day-details-section .event-detail-item { padding: 0.75rem; border-bottom: 1px solid #eee; cursor: default; }
        #day-details-section .event-detail-item:last-child { border-bottom: none; }
        #day-details-section .event-detail-item h4 { margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600; }
        #day-details-section .event-detail-item p { font-size: 0.8rem; color: #6b7280; margin: 0.1rem 0; }
        .event-detail-actions { margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .event-detail-actions a { font-size: 0.7rem; padding: 0.3rem 0.6rem; }
        #add-event-section .form-group { margin-bottom: 0.75rem; }
        #add-event-section .form-group label { font-size: 0.8rem; }
        #add-event-section .form-group input, #add-event-section .form-group textarea { font-size: 0.8rem; padding: 0.4rem; }
        #add-event-section .gemini-suggest-button, #add-event-section button[type="submit"] { font-size: 0.8rem; padding: 0.5rem 0.8rem; }
        #add-event-section .gemini-suggest-button { background-color: #f59e0b; margin-top: 0.5rem; }
        #add-event-section .gemini-suggest-button:hover { background-color: #d97706; }
        .loading-indicator { display: none; font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem; }
        
        @media (min-width: 769px) { 
            .calendar-app-container { padding: 1rem; }
            .navigation-controls { flex-wrap: nowrap; }
            .week-day-card { padding: 1rem; }
            #week-view-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; align-items: start; }
            .collapsible-section { position: fixed; right: 1.5rem; bottom: auto; top: 50%; transform: translateY(-50%); width: 400px; max-height: 90vh; border-radius: 0.75rem; border: 1px solid #e5e7eb; }
        }
    </style>
</head>
<body>
    <div class="calendar-app-container">
        <div class="header-controls">
            <div class="navigation-group">
                <button id="prev-btn" class="nav-button"><i class="fas fa-chevron-left"></i></button>
                <button id="today-btn" class="nav-button"><i class="fas fa-calendar-day"></i></button>
                <button id="next-btn" class="nav-button"><i class="fas fa-chevron-right"></i></button>
            </div>
            <h2 id="current-month-year" class="current-month-display">Month Year</h2>
            <div class="view-toggle-group">
                 <button id="view-toggle-month" class="view-toggle-button active"><i class="fas fa-calendar-alt"></i></button>
                 <button id="view-toggle-week" class="view-toggle-button"><i class="fas fa-calendar-week"></i></button>
            </div>
        </div>

        <div id="search-bar-container" class="search-bar-container">
             <input type="text" id="search-input" placeholder="Search events...">
            <button id="clear-search-btn" class="action-button-style"><i class="fas fa-times"></i></button>
        </div>

        <div id="calendar-grid-container">
            </div>
        <div id="week-view-container" style="display: none;">
            </div>
        
        <div id="day-details-section" class="collapsible-section">
            <div class="collapsible-header">
                <h3 id="day-details-title">Events for Selected Day</h3>
                <button id="close-day-details-btn" class="close-collapsible-btn"><i class="fas fa-times"></i></button>
            </div>
            <div id="day-details-content">
                </div>
        </div>

        <div id="add-event-section" class="collapsible-section">
            <div class="collapsible-header">
                <h3>Add New Event</h3>
                <button id="close-add-event-btn" class="close-collapsible-btn"><i class="fas fa-times"></i></button>
            </div>
            <form id="add-event-form">
                <div class="form-group">
                    <label for="event-keywords">Keywords/Theme for Suggestion:</label>
                    <input type="text" id="event-keywords" placeholder="e.g., kids birthday, summer festival">
                </div>
                <button type="button" id="gemini-suggest-btn" class="action-button-style gemini-suggest-button"><i class="fas fa-magic"></i> Suggest Details</button>
                <div id="suggestion-loading" class="loading-indicator">Fetching suggestions...</div>
                <hr class="my-4 border-gray-300">
                <div class="form-group">
                    <label for="event-name">Event Name:</label>
                    <input type="text" id="event-name" required>
                </div>
                 <div class="form-group">
                    <label for="event-household">Household:</label>
                    <input type="text" id="event-household" placeholder="e.g., Bliss, Miller Family">
                </div>
                <div class="form-group">
                    <label for="event-start-date">Start Date:</label>
                    <input type="date" id="event-start-date" required>
                </div>
                <div class="form-group">
                    <label for="event-end-date">End Date:</label>
                    <input type="date" id="event-end-date" required>
                </div>
                <div class="form-group">
                    <label for="event-description">Description (Optional):</label>
                    <textarea id="event-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="event-location">Location (Optional):</label>
                    <input type="text" id="event-location">
                </div>
                <button type="submit" class="action-button-style" style="background-color: #22c55e;"><i class="fas fa-plus-circle"></i> Add Event</button>
            </form>
        </div>

        <div class="action-drawer-fab">
            <div class="fab-actions" id="fab-actions-menu">
                <div class="fab-action-item" id="fab-action-add"><i class="fas fa-plus"></i> Add Event</div>
                <div class="fab-action-item" id="fab-action-search"><i class="fas fa-search"></i> Search</div>
                <div class="fab-action-item" id="fab-action-print"><i class="fas fa-print"></i> Print</div>
                <div class="fab-action-item" id="fab-action-export"><i class="fas fa-file-csv"></i> Export CSV</div>
            </div>
            <div class="fab-main-button" id="fab-main-btn"><i class="fas fa-bars"></i></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration & State ---
            let viewMode = 'month'; // 'month' or 'week'
            let currentDate = new Date(); // The date that determines the current view
            let allCalendarEvents = []; 
            let displayedEvents = []; 

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            // --- DOM Elements ---
            const calendarGridContainer = document.getElementById('calendar-grid-container');
            const weekViewContainer = document.getElementById('week-view-container');
            const currentMonthYearDisplay = document.getElementById('current-month-year');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const todayBtn = document.getElementById('today-btn');
            const viewToggleMonthBtn = document.getElementById('view-toggle-month');
            const viewToggleWeekBtn = document.getElementById('view-toggle-week');
            const fabActionPrint = document.getElementById('fab-action-print');
            const fabActionExport = document.getElementById('fab-action-export');
            const addEventSection = document.getElementById('add-event-section');
            const dayDetailsSection = document.getElementById('day-details-section');
            const closeAddEventBtn = document.getElementById('close-add-event-btn');
            const addEventForm = document.getElementById('add-event-form');
            const dayDetailsTitle = document.getElementById('day-details-title');
            const dayDetailsContent = document.getElementById('day-details-content');
            const closeDayDetailsBtn = document.getElementById('close-day-details-btn');
            const fabMainBtn = document.getElementById('fab-main-btn');
            const fabActionsMenu = document.getElementById('fab-actions-menu');
            const fabActionAdd = document.getElementById('fab-action-add');
            const fabActionSearch = document.getElementById('fab-action-search');
            const searchBarContainer = document.getElementById('search-bar-container');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const geminiSuggestBtn = document.getElementById('gemini-suggest-btn');
            const eventKeywordsInput = document.getElementById('event-keywords');
            const suggestionLoadingIndicator = document.getElementById('suggestion-loading');
            const eventNameInput = document.getElementById('event-name');
            const eventHouseholdInput = document.getElementById('event-household'); 
            const eventDescriptionInput = document.getElementById('event-description');
            const eventLocationInput = document.getElementById('event-location');
            const eventStartDateInput = document.getElementById('event-start-date');
            const eventEndDateInput = document.getElementById('event-end-date');
            
            // --- Household & Color Functions ---
            const householdColors = { "Claire": "#34d399", "Abby": "#fbbf24", "Natalie": "#ec4899", "Eva": "#818cf8" };
            const defaultHouseholdColor = "#6b7280"; 
            
            function getHouseholdColor(householdName) {
                if (householdName && householdColors[householdName]) { return householdColors[householdName]; }
                if (householdName) { let hash = 0; for (let i = 0; i < householdName.length; i++) { hash = householdName.charCodeAt(i) + ((hash << 5) - hash); } const c = (hash & 0x00FFFFFF).toString(16).toUpperCase(); return "#" + "00000".substring(0, 6 - c.length) + c; }
                return defaultHouseholdColor;
            }
            
            function getContrastingTextColor(hexColor) { 
                if (!hexColor) return '#ffffff'; 
                if (hexColor.length < 7) return '#000000'; // Default to black for invalid short hex
                const r = parseInt(hexColor.slice(1, 3), 16); 
                const g = parseInt(hexColor.slice(3, 5), 16); 
                const b = parseInt(hexColor.slice(5, 7), 16); 
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; 
                return luminance > 0.5 ? '#000000' : '#ffffff'; 
            }

            // --- Event Storage (localStorage) ---
            function loadEventsFromStorage() {
                const storedEvents = localStorage.getItem('calendarTemplateEvents'); // Using a new key for the template
                if (storedEvents) { allCalendarEvents = JSON.parse(storedEvents).map(event => ({ ...event, start: new Date(event.start), end: new Date(event.end), isAllDay: true, household: event.household || "Default" })); } 
                else { allCalendarEvents = []; } // Start with an empty array for the template
                displayedEvents = [...allCalendarEvents]; 
            }

            function saveEventsToStorage() {
                localStorage.setItem('calendarTemplateEvents', JSON.stringify(allCalendarEvents));
            }

            // --- Date/Time Formatting & Link Generation ---
            function formatDateForGoogleAllDay(date) {
                return date.toISOString().substring(0,10).replace(/-/g, "");
            }
            function generateICS(event) {
                const formatDateForICS = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, "");
                const endDateForICS = new Date(event.end);
                endDateForICS.setDate(endDateForICS.getDate() + 1); 
                const dtStart = `DTSTART;VALUE=DATE:${formatDateForICS(event.start).substring(0,8)}`;
                const dtEnd = `DTEND;VALUE=DATE:${formatDateForICS(endDateForICS).substring(0,8)}`;
                
                const icsContent = [
                    "BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//MyCalendar//EN", "BEGIN:VEVENT",
                    `UID:${event.id || new Date().getTime()}@example.com`, `DTSTAMP:${formatDateForICS(new Date())}`,
                    dtStart, dtEnd,
                    `SUMMARY:${event.name} (${event.household})`, 
                    event.description ? `DESCRIPTION:${event.description.replace(/\n/g, '\\n')}` : "",
                    event.location ? `LOCATION:${event.location}` : "",
                    "END:VEVENT", "END:VCALENDAR"
                ].filter(line => line).join("\r\n");
                return icsContent;
            }
            function generateGoogleCalendarLink(event) {
                const baseUrl = "https://www.google.com/calendar/render";
                const params = new URLSearchParams();
                params.append('action', 'TEMPLATE');
                params.append('text', `${event.name} (${event.household})`); 

                const endDateForGoogle = new Date(event.end);
                endDateForGoogle.setDate(endDateForGoogle.getDate() + 1); 
                params.append('dates', `${formatDateForGoogleAllDay(event.start)}/${formatDateForGoogleAllDay(endDateForGoogle)}`);
                
                if (event.description) params.append('details', event.description);
                if (event.location) params.append('location', event.location);
                return `${baseUrl}?${params.toString()}`;
            }

            // --- UI Toggling Functions ---
            function toggleCollapsibleSection(sectionElement, show) {
                if (show) {
                    if (sectionElement !== addEventSection) addEventSection.classList.remove('active');
                    if (sectionElement !== dayDetailsSection) dayDetailsSection.classList.remove('active');
                    sectionElement.classList.add('active');
                } else {
                    sectionElement.classList.remove('active');
                }
            }

            // --- Main Rendering Logic ---
            function render() {
                if (viewMode === 'month') {
                    calendarGridContainer.style.display = 'block';
                    weekViewContainer.style.display = 'none';
                    renderMonthView(currentDate.getFullYear(), currentDate.getMonth());
                } else {
                    calendarGridContainer.style.display = 'none';
                    weekViewContainer.style.display = 'flex';
                    renderWeekView(currentDate);
                }
            }
            
            // --- Month View Rendering ---
            function renderMonthView(year, month) {
                calendarGridContainer.innerHTML = '';
                currentMonthYearDisplay.textContent = `${monthNames[month]} ${year}`;
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month';
                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';
                dayNames.forEach(dayName => { const dayLabel = document.createElement('div'); dayLabel.className = 'day-label'; dayLabel.textContent = dayName; daysGrid.appendChild(dayLabel); });
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const firstDayOfWeek = firstDayOfMonth.getDay();
                const totalDaysInMonth = lastDayOfMonth.getDate();
                const today = new Date();
                for (let i = 0; i < firstDayOfWeek; i++) { const emptyCell = document.createElement('div'); emptyCell.className = 'day-cell other-month'; daysGrid.appendChild(emptyCell); }
                for (let day = 1; day <= totalDaysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    const currentDayDate = new Date(year, month, day);
                    dayCell.dataset.date = currentDayDate.toISOString().split('T')[0];
                    const dayNumberSpan = document.createElement('span');
                    dayNumberSpan.className = 'day-number';
                    dayNumberSpan.textContent = day;
                    dayCell.appendChild(dayNumberSpan);
                    if (currentDayDate.getFullYear() === today.getFullYear() && currentDayDate.getMonth() === today.getMonth() && currentDayDate.getDate() === today.getDate()) {
                        dayCell.classList.add('today');
                    }
                    const eventsOnThisDay = displayedEvents.filter(event => { const eventStartDay = new Date(event.start.getFullYear(), event.start.getMonth(), event.start.getDate()); const eventEndDay = new Date(event.end.getFullYear(), event.end.getMonth(), event.end.getDate()); return currentDayDate >= eventStartDay && currentDayDate <= eventEndDay; });
                    if (eventsOnThisDay.length > 0) {
                        if (window.innerWidth <= 768) {
                            eventsOnThisDay.slice(0, 3).forEach(event => { const eventDot = document.createElement('div'); eventDot.className = `event-dot`; eventDot.style.backgroundColor = getHouseholdColor(event.household); dayCell.appendChild(eventDot); });
                        } else {
                            eventsOnThisDay.slice(0, 2).forEach(event => { const eventDiv = document.createElement('div'); eventDiv.className = `event`; const bgColor = getHouseholdColor(event.household); eventDiv.style.backgroundColor = bgColor; eventDiv.style.color = getContrastingTextColor(bgColor); eventDiv.textContent = event.name; eventDiv.title = `${event.name} (${event.household})`; dayCell.appendChild(eventDiv); });
                        }
                    }
                    dayCell.onclick = () => openDayDetails(currentDayDate, eventsOnThisDay);
                    daysGrid.appendChild(dayCell);
                }
                const totalCells = firstDayOfWeek + totalDaysInMonth;
                const remainingCells = (7 - (totalCells % 7)) % 7;
                for (let i = 0; i < remainingCells; i++) { const emptyCell = document.createElement('div'); emptyCell.className = 'day-cell other-month'; daysGrid.appendChild(emptyCell); }
                monthDiv.appendChild(daysGrid);
                calendarGridContainer.appendChild(monthDiv);
            }

            // --- Week View Rendering ---
            function renderWeekView(date) {
                weekViewContainer.innerHTML = '';
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const startOfWeek = new Date(date);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                
                currentMonthYearDisplay.textContent = `Week of ${startOfWeek.toLocaleDateString(undefined, {month: 'long', day: 'numeric'})}`;

                for (let i = 0; i < 7; i++) {
                    const currentDayDate = new Date(startOfWeek);
                    currentDayDate.setDate(startOfWeek.getDate() + i);
                    
                    const card = document.createElement('div');
                    card.className = 'week-day-card';
                    if (currentDayDate.getTime() === today.getTime()) {
                        card.classList.add('today');
                    }

                    const eventsOnThisDay = displayedEvents.filter(event => {
                        const eventStartDay = new Date(event.start.getFullYear(), event.start.getMonth(), event.start.getDate());
                        const eventEndDay = new Date(event.end.getFullYear(), event.end.getMonth(), event.end.getDate());
                        return currentDayDate >= eventStartDay && currentDayDate <= eventEndDay;
                    });
                    
                    let eventsHtml = '';
                    if (eventsOnThisDay.length > 0) {
                        eventsOnThisDay.forEach(event => {
                            const bgColor = getHouseholdColor(event.household);
                            const textColor = getContrastingTextColor(bgColor);
                            eventsHtml += `<div class="event" style="background-color: ${bgColor}; color: ${textColor};" title="${event.name} (${event.household})">${event.name} (${event.household})</div>`;
                        });
                    } else {
                        eventsHtml = '<p class="text-xs text-gray-400 italic">No events</p>';
                    }

                    card.innerHTML = `
                        <div class="week-day-header">
                            <span class="week-day-name">${dayNames[currentDayDate.getDay()]}</span>
                            <span class="week-day-date">${currentDayDate.getDate()}</span>
                        </div>
                        <div class="week-day-events">${eventsHtml}</div>
                    `;
                    card.onclick = () => openDayDetails(currentDayDate, eventsOnThisDay);
                    weekViewContainer.appendChild(card);
                }
            }
            
            // --- Day Details Accordion ---
            function openDayDetails(date, eventsForDay) {
                dayDetailsTitle.textContent = `Events for ${date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}`;
                dayDetailsContent.innerHTML = ''; 

                if (eventsForDay.length === 0) {
                    dayDetailsContent.innerHTML = '<p class="text-gray-500 italic">No events scheduled for this day.</p>';
                } else {
                    eventsForDay.forEach(event => {
                        const eventItem = document.createElement('div');
                        eventItem.className = 'event-detail-item';
                        
                        const eventColor = getHouseholdColor(event.household);
                        const eventNameColor = getContrastingTextColor(eventColor);

                        eventItem.innerHTML = `
                            <h4 class="font-semibold" style="color: ${eventNameColor}; background-color: ${eventColor}; padding: 0.2rem 0.4rem; border-radius: 0.25rem; display: inline-block;">${event.name}</h4>
                            <p><strong>Household:</strong> ${event.household || 'N/A'}</p>
                            <p><strong>Time:</strong> All Day</p>
                            ${event.description ? `<p><strong>Description:</strong> ${event.description}</p>` : ''}
                            ${event.location ? `<p><strong>Location:</strong> ${event.location}</p>` : ''}
                            <div class="event-detail-actions">
                                <a href="${generateGoogleCalendarLink(event)}" target="_blank" rel="noopener noreferrer" class="action-button-style" style="background-color: #4285F4; font-size: 0.7rem; padding: 0.2rem 0.5rem;"><i class="fab fa-google"></i> Google</a>
                                <a href="data:text/calendar;charset=utf8,${encodeURIComponent(generateICS(event))}" download="${event.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics" class="action-button-style" style="background-color: #22c55e; font-size: 0.7rem; padding: 0.2rem 0.5rem;"><i class="fas fa-file-download"></i> .ics</a>
                            </div>
                        `;
                        dayDetailsContent.appendChild(eventItem);
                    });
                }
                toggleCollapsibleSection(dayDetailsSection, true);
            }
            
            // --- Gemini API Event Suggestion ---
            async function fetchEventSuggestions() {
                const keywords = eventKeywordsInput.value.trim();
                if (!keywords) { alert("Please enter some keywords or a theme for suggestions."); return; }
                suggestionLoadingIndicator.style.display = 'block';
                geminiSuggestBtn.disabled = true;
                const prompt = `Suggest a fun and creative event name, a brief engaging description (1-2 sentences), a plausible location, a suitable start date (YYYY-MM-DD format), end date (YYYY-MM-DD format), and a household name (e.g., "Smith Family", "Book Club") based on these keywords: "${keywords}". The event should ideally be within ${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}, or a plausible future date if the keywords strongly suggest it. All events are all-day. Provide the response as a single, valid JSON object.`;
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT", properties: { "name": { "type": "STRING" }, "description": { "type": "STRING" }, "location": { "type": "STRING" }, "household": { "type": "STRING" }, "startDate": { "type": "STRING", "description": "YYYY-MM-DD format" }, "endDate": { "type": "STRING", "description": "YYYY-MM-DD format" } },
                            required: ["name", "description", "location", "startDate", "endDate", "household"]
                        }
                    }
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Gemini API Error:", errorData);
                        alert(`Error fetching suggestions: ${errorData.error?.message || response.statusText}`);
                        return;
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const suggestedText = result.candidates[0].content.parts[0].text;
                        try {
                            const suggestions = JSON.parse(suggestedText);
                            eventNameInput.value = suggestions.name || '';
                            eventHouseholdInput.value = suggestions.household || '';
                            eventDescriptionInput.value = suggestions.description || '';
                            eventLocationInput.value = suggestions.location || '';
                            if (suggestions.startDate && /^\d{4}-\d{2}-\d{2}$/.test(suggestions.startDate)) {
                                eventStartDateInput.value = suggestions.startDate;
                            }
                            if (suggestions.endDate && /^\d{4}-\d{2}-\d{2}$/.test(suggestions.endDate)) {
                                eventEndDateInput.value = suggestions.endDate;
                            }
                        } catch (parseError) {
                            console.error("Error parsing Gemini JSON response:", parseError, "\nRaw text:", suggestedText);
                            alert("Received suggestions, but couldn't parse them.");
                            if (suggestedText) {
                                eventNameInput.value = `Suggestion (raw): ${suggestedText.substring(0, 50)}...`;
                            }
                        }
                    } else {
                        console.warn("Gemini API response structure unexpected or content missing:", result);
                        alert("No suggestions received or the response was empty.");
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    alert("An error occurred while trying to get suggestions.");
                } finally {
                    suggestionLoadingIndicator.style.display = 'none';
                    geminiSuggestBtn.disabled = false;
                }
            }

            // --- CSV Export ---
            function exportEventsToCSV() {
                const headers = ["ID", "Event Name", "Household", "Start Date", "End Date", "Description", "Location"];
                const rows = allCalendarEvents.map(event => [
                    escapeCsvCell(event.id), escapeCsvCell(event.name),
                    escapeCsvCell(event.household),
                    escapeCsvCell(event.start.toISOString().substring(0, 10)),
                    escapeCsvCell(event.end.toISOString().substring(0, 10)),
                    escapeCsvCell(event.description), escapeCsvCell(event.location)
                ]);
                let csvContent = headers.join(",") + "\r\n";
                rows.forEach(rowArray => {
                    csvContent += rowArray.join(",") + "\r\n";
                });
                const blob = new Blob([csvContent], {
                    type: 'text/csv;charset=utf-8;'
                });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "calendar_events_export.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert("CSV export is not supported by your browser.");
                }
            }

            // --- Print Function ---
            function printCalendar() {
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert("Please allow pop-ups for this site to print the calendar.");
                    return;
                }

                const monthsWithEvents = new Set();
                allCalendarEvents.forEach(event => {
                    let d = new Date(event.start.getTime());
                    while (d <= event.end) {
                        monthsWithEvents.add(`${d.getFullYear()}-${d.getMonth()}`);
                        d.setDate(d.getDate() + 1);
                    }
                });

                const sortedMonths = Array.from(monthsWithEvents).sort((a, b) => {
                    const [yearA, monthA] = a.split('-').map(Number);
                    const [yearB, monthB] = b.split('-').map(Number);
                    return yearA - yearB || monthA - monthB;
                });

                let printContent = '';
                sortedMonths.forEach(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    let monthHtml = `<div class="print-month-container">
                        <h2 class="print-month-header">${monthNames[month]} ${year}</h2>
                        <div class="print-days-grid">`;

                    dayNames.forEach(dayName => monthHtml += `<div class="print-day-label">${dayName}</div>`);

                    const firstDayOfMonth = new Date(year, month, 1);
                    const lastDayOfMonth = new Date(year, month + 1, 0);
                    const firstDayOfWeek = firstDayOfMonth.getDay();

                    for (let i = 0; i < firstDayOfWeek; i++) {
                        monthHtml += '<div></div>';
                    }

                    for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                        let cellContent = `<div class="print-day-cell"><div class="print-day-number">${day}</div>`;

                        const currentPrintDate = new Date(year, month, day);
                        const eventsOnThisDay = allCalendarEvents.filter(event => {
                            const eventStartDay = new Date(event.start.getFullYear(), event.start.getMonth(), event.start.getDate());
                            const eventEndDay = new Date(event.end.getFullYear(), event.end.getMonth(), event.end.getDate());
                            return currentPrintDate >= eventStartDay && currentPrintDate <= eventEndDay;
                        });

                        eventsOnThisDay.forEach(event => {
                            const bgColor = getHouseholdColor(event.household);
                            const textColor = getContrastingTextColor(bgColor);
                            cellContent += `<div class="print-event-item" style="background-color:${bgColor}; color:${textColor}">${event.name} (${event.household})</div>`;
                        });

                        cellContent += '</div>';
                        monthHtml += cellContent;
                    }
                    monthHtml += '</div></div>';
                    printContent += monthHtml;
                });

                const printHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Printable Calendar</title>
                        <style>
                            body { font-family: sans-serif; }
                            .print-month-container { page-break-after: always; margin-bottom: 20px; }
                            .print-month-container:last-child { page-break-after: auto; }
                            .print-month-header { font-size: 24px; text-align: center; margin-bottom: 10px; }
                            .print-days-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #000; }
                            .print-day-label { text-align: center; font-weight: bold; padding: 5px; border-bottom: 1px solid #000; background-color: #eee; }
                            .print-day-cell { min-height: 100px; border-left: 1px solid #ccc; border-top: 1px solid #ccc; padding: 4px; }
                            .print-day-number { font-weight: bold; text-align: right; }
                            .print-event-item { font-size: 11px; padding: 2px 4px; border-radius: 3px; margin-top: 3px; overflow-wrap: break-word; }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                    </html>
                `;

                printWindow.document.write(printHTML);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            }

            // --- Event Handlers ---
            prevBtn.onclick = () => { if (viewMode === 'month') { currentDate.setMonth(currentDate.getMonth() - 1); } else { currentDate.setDate(currentDate.getDate() - 7); } render(); };
            nextBtn.onclick = () => { if (viewMode === 'month') { currentDate.setMonth(currentDate.getMonth() + 1); } else { currentDate.setDate(currentDate.getDate() + 7); } render(); };
            todayBtn.onclick = () => { currentDate = new Date(); render(); };
            viewToggleMonthBtn.onclick = () => { viewMode = 'month'; viewToggleMonthBtn.classList.add('active'); viewToggleWeekBtn.classList.remove('active'); render(); };
            viewToggleWeekBtn.onclick = () => { viewMode = 'week'; viewToggleWeekBtn.classList.add('active'); viewToggleMonthBtn.classList.remove('active'); render(); };

            fabActionPrint.onclick = printCalendar;
            fabActionExport.onclick = exportEventsToCSV;
            closeAddEventBtn.onclick = () => toggleCollapsibleSection(addEventSection, false);
            closeDayDetailsBtn.onclick = () => toggleCollapsibleSection(dayDetailsSection, false);
            
            addEventForm.onsubmit = (e) => {
                e.preventDefault();
                const eventNameVal = eventNameInput.value;
                const householdVal = eventHouseholdInput.value.trim() || "Default";
                const startDateStr = eventStartDateInput.value;
                const endDateStr = eventEndDateInput.value;
                const descriptionVal = eventDescriptionInput.value;
                const locationVal = eventLocationInput.value;
                if (!eventNameVal || !startDateStr || !endDateStr) {
                    alert("Event name, start date, and end date are required.");
                    return;
                }
                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T00:00:00');
                if (endDate < startDate) {
                    alert("End date cannot be before start date.");
                    return;
                }
                const newEvent = {
                    id: `user-${new Date().getTime()}`,
                    name: eventNameVal,
                    household: householdVal,
                    start: startDate,
                    end: endDate,
                    description: descriptionVal,
                    location: locationVal,
                    isAllDay: true
                };
                allCalendarEvents.push(newEvent);
                displayedEvents = [...allCalendarEvents];
                saveEventsToStorage();
                render();
                addEventForm.reset();
                toggleCollapsibleSection(addEventSection, false);
            };

            geminiSuggestBtn.onclick = fetchEventSuggestions;
            fabMainBtn.onclick = () => fabActionsMenu.classList.toggle('active');
            fabActionAdd.onclick = () => { toggleCollapsibleSection(addEventSection, true); fabActionsMenu.classList.remove('active'); };
            fabActionSearch.onclick = () => { searchBarContainer.style.display = searchBarContainer.style.display === 'none' || searchBarContainer.style.display === '' ? 'flex' : 'none'; if (searchBarContainer.style.display === 'flex') searchInput.focus(); fabActionsMenu.classList.remove('active'); };
            searchInput.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); if (!searchTerm) { displayedEvents = [...allCalendarEvents]; } else { displayedEvents = allCalendarEvents.filter(event => event.name.toLowerCase().includes(searchTerm) || (event.household && event.household.toLowerCase().includes(searchTerm)) || (event.description && event.description.toLowerCase().includes(searchTerm)) || (event.location && event.location.toLowerCase().includes(searchTerm))); } render(); });
            clearSearchBtn.onclick = () => { searchInput.value = ''; displayedEvents = [...allCalendarEvents]; render(); searchBarContainer.style.display = 'none'; };

            // --- Initial Load ---
            loadEventsFromStorage();
            currentDate = new Date(2025, 5, 1);
            render();
        });
    </script>
</body>
</html>
